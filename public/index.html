<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>System Monitor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #4CAF50;
    }

    .card {
      background: #222;
      font-size: 1.2em;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }

    .card h3 {
      margin: 0 0 10px 0;
      color: #4CAF50;
      font-size: 1.1em;
    }

    .card-content {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .metric {
      flex: 1;
      min-width: 200px;
    }

    .metric-label {
      color: #aaa;
      font-size: 0.9em;
    }

    .metric-value {
      color: #fff;
      font-size: 1.1em;
      font-weight: bold;
    }

    .network-interface {
      background: #1a1a1a;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
    }

    .ip-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .ip-item {
      background: #1a1a1a;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
    }

    .throttling-normal {
      color: #4CAF50;
    }

    .throttling-warning {
      color: #ff9800;
    }

    .throttling-error {
      color: #f44336;
    }
  </style>
</head>

<body>
  <h1>üìä Raspberry Pi Monitor</h1>

  <div class="card">
    <h3>‚è±Ô∏è Uptime</h3>
    <div class="metric-value" id="uptime"></div>
  </div>

  <div class="card">
    <h3>üß† CPU Load Average</h3>
    <div class="card-content">
      <div class="metric">
        <div class="metric-label">1 minute:</div>
        <div class="metric-value" id="load1min"></div>
      </div>
      <div class="metric">
        <div class="metric-label">5 minutes:</div>
        <div class="metric-value" id="load5min"></div>
      </div>
      <div class="metric">
        <div class="metric-label">15 minutes:</div>
        <div class="metric-value" id="load15min"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>üßÆ RAM</h3>
    <div class="metric-value" id="ram"></div>
  </div>

  <div class="card">
    <h3>üå°Ô∏è Temperature</h3>
    <div class="card-content">
      <div class="metric">
        <div class="metric-label">CPU:</div>
        <div class="metric-value" id="temp-cpu"></div>
      </div>
      <div class="metric">
        <div class="metric-label">GPU:</div>
        <div class="metric-value" id="temp-gpu"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>üíæ Disk</h3>
    <div class="metric-value" id="disk"></div>
  </div>

  <div class="card">
    <h3>üåê Network Usage</h3>
    <div id="network"></div>
  </div>

  <div class="card">
    <h3>üìç IP Addresses</h3>
    <div class="card-content">
      <div class="metric">
        <div class="metric-label">Public IP:</div>
        <div class="metric-value" id="public-ip"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Local IPv4:</div>
        <div class="ip-list" id="local-ipv4"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Local IPv6:</div>
        <div class="ip-list" id="local-ipv6"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>‚ö° Throttling Status</h3>
    <div class="metric-value" id="throttling"></div>
  </div>

  <div class="card">
    <h3>üß≤ Transmission</h3>
    <div class="card-content">
      <div class="metric">
        <div class="metric-label">Estado:</div>
        <div class="metric-value" id="transmission-status"></div>
      </div>
      <div class="metric">
        <div class="metric-label">‚Üì Velocidad global:</div>
        <div class="metric-value" id="transmission-download"></div>
      </div>
      <div class="metric">
        <div class="metric-label">‚Üë Velocidad global:</div>
        <div class="metric-value" id="transmission-upload"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Torrents activos:</div>
        <div class="metric-value" id="transmission-active-count"></div>
      </div>
    </div>
    <div id="transmission-torrents"></div>
  </div>
  <div class="card">
    <h3>üìà Hist√≥ricos</h3>
    <div class="card-content">
      <div class="metric" style="min-width: 300px;">
        <div class="metric-label">CPU Load (1m)</div>
        <canvas id="chart-cpu"></canvas>
      </div>
      <div class="metric" style="min-width: 300px;">
        <div class="metric-label">% RAM usada</div>
        <canvas id="chart-ram"></canvas>
      </div>
      <div class="metric" style="min-width: 300px;">
        <div class="metric-label">% Disco usado</div>
        <canvas id="chart-disk"></canvas>
      </div>
      <div class="metric" style="min-width: 300px;">
        <div class="metric-label">Red ‚Üì/‚Üë (bps)</div>
        <canvas id="chart-net"></canvas>
      </div>
      <div class="metric" style="min-width: 300px;">
        <div class="metric-label">Transmission ‚Üì/‚Üë (bps)</div>
        <canvas id="chart-tx"></canvas>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    async function loadStats() {
      try {
        const res = await fetch("/api/stats");
        const data = await res.json();

        // Uptime
        document.getElementById("uptime").textContent = data.uptime.formatted;

        // CPU Load Average
        document.getElementById("load1min").textContent = data.cpu.load1min;
        document.getElementById("load5min").textContent = data.cpu.load5min;
        document.getElementById("load15min").textContent = data.cpu.load15min;

        // RAM
        document.getElementById("ram").textContent =
          `${data.memory.used} / ${data.memory.total} MB`;

        // Temperature
        document.getElementById("temp-cpu").textContent = data.temperature.cpu;
        document.getElementById("temp-gpu").textContent = data.temperature.gpu;

        // Disk
        document.getElementById("disk").textContent =
          `${data.disk.used} / ${data.disk.size}`;

        // Network Usage
        const networkDiv = document.getElementById("network");
        const bandwidth = data.network.bandwidth || {};
        const totals = data.network.totals || {};
        if (Object.keys(bandwidth).length === 0) {
          networkDiv.innerHTML = '<div class="metric-value">Collecting data...</div>';
        } else {
          let networkHTML = "";
          if (totals.aggregate) {
            networkHTML += `
              <div class="network-interface">
                <strong>Total (todas las interfaces):</strong><br>
                <span class="metric-label">‚Üì Total:</span> ${totals.aggregate.rxTotal}<br>
                <span class="metric-label">‚Üë Total:</span> ${totals.aggregate.txTotal}
              </div>
            `;
          }
          for (const [interface, stats] of Object.entries(bandwidth)) {
            const ifaceTotals = totals.perInterface ? totals.perInterface[interface] : null;
            networkHTML += `
              <div class="network-interface">
                <strong>${interface}:</strong><br>
                <span class="metric-label">‚Üì Download:</span> ${stats.rx}<br>
                <span class="metric-label">‚Üë Upload:</span> ${stats.tx}<br>
                ${ifaceTotals ? `
                  <span class="metric-label">‚Üì Total:</span> ${ifaceTotals.rxTotal}<br>
                  <span class="metric-label">‚Üë Total:</span> ${ifaceTotals.txTotal}
                ` : ``}
              </div>
            `;
          }
          networkDiv.innerHTML = networkHTML || '<div class="metric-value">No active interfaces</div>';
        }

        // IP Addresses
        document.getElementById("public-ip").textContent = data.ipAddresses.public;

        const ipv4Div = document.getElementById("local-ipv4");
        if (data.ipAddresses.local.ipv4.length === 0) {
          ipv4Div.innerHTML = '<div class="ip-item">None</div>';
        } else {
          ipv4Div.innerHTML = data.ipAddresses.local.ipv4
            .map(ip => `<div class="ip-item">${ip.interface}: ${ip.address}</div>`)
            .join("");
        }

        const ipv6Div = document.getElementById("local-ipv6");
        if (data.ipAddresses.local.ipv6.length === 0) {
          ipv6Div.innerHTML = '<div class="ip-item">None</div>';
        } else {
          ipv6Div.innerHTML = data.ipAddresses.local.ipv6
            .map(ip => `<div class="ip-item">${ip.interface}: ${ip.address}</div>`)
            .join("");
        }

        // Throttling Status
        const throttlingDiv = document.getElementById("throttling");
        const throttlingStatus = data.throttling.status;
        let throttlingClass = "throttling-normal";
        if (throttlingStatus !== "Normal") {
          throttlingClass = throttlingStatus.includes("Throttled") || throttlingStatus.includes("Undervoltage")
            ? "throttling-error"
            : "throttling-warning";
        }
        throttlingDiv.className = `metric-value ${throttlingClass}`;
        throttlingDiv.textContent = throttlingStatus;

        // Transmission
        const tx = data.transmission || {};
        const txStatusDiv = document.getElementById("transmission-status");
        const txDlDiv = document.getElementById("transmission-download");
        const txUlDiv = document.getElementById("transmission-upload");
        const txActiveCountDiv = document.getElementById("transmission-active-count");
        const txTorrentsDiv = document.getElementById("transmission-torrents");
        if (!tx.enabled) {
          txStatusDiv.textContent = tx.reason ? `Deshabilitado (${tx.reason})` : "Deshabilitado";
          txDlDiv.textContent = "-";
          txUlDiv.textContent = "-";
          txActiveCountDiv.textContent = "0";
          txTorrentsDiv.innerHTML = tx.reason
            ? `<div class="metric-value">${tx.reason}</div>`
            : '<div class="metric-value">No hay datos</div>';
        } else if (tx.error) {
          txStatusDiv.textContent = tx.error;
          txDlDiv.textContent = "-";
          txUlDiv.textContent = "-";
          txActiveCountDiv.textContent = "0";
          txTorrentsDiv.innerHTML = '<div class="metric-value">Error obteniendo torrents</div>';
        } else {
          txStatusDiv.textContent = "OK";
          txDlDiv.textContent = tx.session?.download || "-";
          txUlDiv.textContent = tx.session?.upload || "-";
          txActiveCountDiv.textContent = String(tx.session?.activeTorrents ?? 0);
          const list = Array.isArray(tx.torrents) ? tx.torrents : [];
          if (list.length === 0) {
            txTorrentsDiv.innerHTML = '<div class="metric-value">Sin torrents activos</div>';
          } else {
            txTorrentsDiv.innerHTML = list
              .map(t => `
                <div class="network-interface">
                  <strong>${t.name}</strong><br>
                  <span class="metric-label">Estado:</span> ${t.status}<br>
                  <span class="metric-label">‚Üì:</span> ${t.download} &nbsp; 
                  <span class="metric-label">‚Üë:</span> ${t.upload} &nbsp; 
                  <span class="metric-label">Progreso:</span> ${t.progress}
                </div>
              `)
              .join("");
          }
        }
      } catch (error) {
        console.error("Error loading stats:", error);
      }
    }

    loadStats();
    setInterval(loadStats, 5000);
    let charts = { cpu: null, ram: null, disk: null, net: null, tx: null };
    function makeLineChart(ctx, label, datasets) {
      return new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { ticks: { color: "#aaa" }, grid: { color: "#333" } },
            y: { ticks: { color: "#aaa" }, grid: { color: "#333" } },
          },
          plugins: {
            legend: { labels: { color: "#eee" } },
          },
        },
      });
    }
    async function loadHistory() {
      try {
        const res = await fetch("/api/history?rangeSeconds=3600");
        const { samples } = await res.json();
        const labels = samples.map(s => new Date(s.ts_ms).toLocaleTimeString());
        const cpu1 = samples.map(s => s.cpu_load1);
        const ramPct = samples.map(s => s.mem_total_mb > 0 ? Math.round((s.mem_used_mb / s.mem_total_mb) * 100) : 0);
        const diskPct = samples.map(s => s.disk_used_percent);
        const netRx = samples.map(s => s.net_rx_bps);
        const netTx = samples.map(s => s.net_tx_bps);
        const txDl = samples.map(s => s.tx_download_bps);
        const txUl = samples.map(s => s.tx_upload_bps);
        if (!charts.cpu) {
          charts.cpu = makeLineChart(document.getElementById("chart-cpu"), "CPU", [{
            label: "Load 1m",
            data: cpu1,
            borderColor: "#4CAF50",
            tension: 0.2,
          }]);
        } else {
          charts.cpu.data.datasets[0].data = cpu1;
        }
        charts.cpu.data.labels = labels;
        charts.cpu.update();
        if (!charts.ram) {
          charts.ram = makeLineChart(document.getElementById("chart-ram"), "RAM", [{
            label: "% usada",
            data: ramPct,
            borderColor: "#03A9F4",
            tension: 0.2,
          }]);
        } else {
          charts.ram.data.datasets[0].data = ramPct;
        }
        charts.ram.data.labels = labels;
        charts.ram.update();
        if (!charts.disk) {
          charts.disk = makeLineChart(document.getElementById("chart-disk"), "Disco", [{
            label: "% usado",
            data: diskPct,
            borderColor: "#FFC107",
            tension: 0.2,
          }]);
        } else {
          charts.disk.data.datasets[0].data = diskPct;
        }
        charts.disk.data.labels = labels;
        charts.disk.update();
        if (!charts.net) {
          charts.net = makeLineChart(document.getElementById("chart-net"), "Red", [
            { label: "‚Üì bps", data: netRx, borderColor: "#8BC34A", tension: 0.2 },
            { label: "‚Üë bps", data: netTx, borderColor: "#E91E63", tension: 0.2 },
          ]);
        } else {
          charts.net.data.datasets[0].data = netRx;
          charts.net.data.datasets[1].data = netTx;
        }
        charts.net.data.labels = labels;
        charts.net.update();
        if (!charts.tx) {
          charts.tx = makeLineChart(document.getElementById("chart-tx"), "Transmission", [
            { label: "‚Üì bps", data: txDl, borderColor: "#00BCD4", tension: 0.2 },
            { label: "‚Üë bps", data: txUl, borderColor: "#9C27B0", tension: 0.2 },
          ]);
        } else {
          charts.tx.data.datasets[0].data = txDl;
          charts.tx.data.datasets[1].data = txUl;
        }
        charts.tx.data.labels = labels;
        charts.tx.update();
      } catch (e) {
      }
    }
    loadHistory();
    setInterval(loadHistory, 10000);
  </script>
</body>

</html>
